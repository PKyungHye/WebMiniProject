<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>buy main</title>
<style type="text/css">
table {
	border-collapse: collapse;
}
th {
	width: 50%;
}
table, th, td {
	border: 1px solid black;
	text-align: center;
}
.table_container {
	width: 32%;
	float: left;
	padding-right: 1%;
}
</style>
</head>
<body>
	<h3>이용권 비교</h3>
	<div>
		사이트: 
		<input type="checkbox" id="checkAll" onclick="checkAll()">전체
		<input type="checkbox" name="sites" id="genie" onclick="offCheckAll()">지니
		<input type="checkbox" name="sites" id="bugs" onclick="offCheckAll()">벅스
		<input type="checkbox" name="sites" id="melon" onclick="offCheckAll()">멜론<br>
		
		가격: 
		<input name="price" type="number" size="3" min="0" step="500" max="49500" value="0" required>원 이상 ~ 
		<input name="price" type="number" size="3" min="500" step="500" max="50000" value="50000" required>원 이하<br>
		
		<button onclick="loadDoc()">검색</button>
	</div>
	
	<div class="table_container" id="viewGenie" style="display: none;">
		<table align="center">
			<caption>Genie</caption>
			<tr><th>이용권</th><th>가격</th></tr>
			<tbody id="dataGenie"></tbody>
		</table>
		<p align="center">
			<a href="https://www.genie.co.kr/buy/thirtyDays" target="_blank">
				<button>Genie</button>
			</a>
		</p>
	</div>
	<div class="table_container" id="viewBugs" style="display: none;">
		<table align="center">
			<caption>Bugs</caption>
			<tr><th>이용권</th><th colspan="2">가격</th></tr>
			<tbody id="dataBugs"></tbody>
		</table>
		<p align="center">
			<a href="https://music.bugs.co.kr/pay/public" target="_blank">
				<button>Bugs</button>
			</a>
		</p>
	</div>
	<div class="table_container" id="viewMelon" style="display: none;">
		<table align="center">
			<caption>Melon</caption>
			<tr><th>이용권</th><th colspan="2">가격</th></tr>
			<tbody id="dataMelon"></tbody>
		</table>
		<p align="center">
			<a href="https://www.melon.com/buy/pamphlet/all.htm" target="_blank">
				<button>Melon</button>
			</a>
		</p>
	</div>
	
	<script type="text/javascript">
		function checkAll() {
			document.getElementsByName("sites").forEach(f1);
		    function f1(item) {
		    	if (document.getElementById("checkAll").checked) {
		    		item.checked = true;
		        } else {
		        	item.checked = false;
		        }
		    }
		}
		
		var count;
		function offCheckAll() {
			count = 0;
			document.getElementsByName("sites").forEach(f1);
		    function f1(item) {
		    	if (item.checked) {
		    		count += 1;
		    	}
		    }
			if (count == document.getElementsByName("sites").length) {
				document.getElementById("checkAll").checked = true;
			} else {
				document.getElementById("checkAll").checked = false;
			}
		}
		
		function priceToString(num) {
			var s = num.toString();
			var str = "";
			if (s.length >= 4) {
				str = s.substr(0, s.length-3) + "," + s.substr(s.length-3);
			} else {
				str = s;
			}
			
			return str;
		}
	
		function loadDoc() {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
			    if (this.readyState == 4 && this.status == 200) {
			    	if (Number(document.getElementsByName("price")[0].value) <= Number(document.getElementsByName("price")[1].value)) {
						document.getElementById("viewGenie").style.display = "none";
						document.getElementById("viewBugs").style.display = "none";
						document.getElementById("viewMelon").style.display = "none";

						var viewTr = "";
						var trGenie = "";
						var trBugs = "";
						var trMelon = "";
						
						if (document.getElementById("genie").checked) {
							listGenie = JSON.parse(this.responseText).genie;
							viewTr = "";
							listGenie.forEach(drawTable);
							trGenie = checkViewTr(viewTr);
							document.getElementById("viewGenie").style.display = "block";
							document.getElementById("dataGenie").innerHTML = trGenie;
						}
						if (document.getElementById("bugs").checked) {
							listBugs = JSON.parse(this.responseText).bugs;
							viewTr = "";
							listBugs.forEach(drawTable);
							trBugs = checkViewTr(viewTr);
							document.getElementById("viewBugs").style.display = "block";
							document.getElementById("dataBugs").innerHTML = trBugs;
						}
						if (document.getElementById("melon").checked) {
							listMelon = JSON.parse(this.responseText).melon;
							viewTr = "";
							listMelon.forEach(drawTable);
							trMelon = checkViewTr(viewTr);
							document.getElementById("viewMelon").style.display = "block";
							document.getElementById("dataMelon").innerHTML = trMelon;
						}
						
						function drawTable(item) {
							if(item.title != null) {
								var newInfo = [];
								item.info.forEach(checkPrice);
								function checkPrice(item2) {
									if ( (item2.price >= Number(document.getElementsByName("price")[0].value))
										&& (item2.price <= Number(document.getElementsByName("price")[1].value)) ) {
										newInfo.push(item2);
									}
								}
								item.info = newInfo;
								
								var spanNum = 1;
								spanNum = item.info.length;
								if (spanNum > 0) {
									viewTr += "<tr><td rowspan="+ spanNum +">" + item.title + "</td>";
									item.info.forEach(fe3);
									function fe3(item2) {
										if (item2.type != null) {
											viewTr += "<td>" + item2.type + "</td><td width=\"25%\">" + priceToString(item2.price) + "<small>원</small></td></tr>";
										} else {
											viewTr += "<td>" + priceToString(item2.price) + "<small>원</small></td></tr>";
										}
									}
								}
							} else {
								viewTr += "<tr><td colspan=\"2\">" + item + "</td></tr>";
							}
						}
						
						function checkViewTr(str) {
							if (str == "") {
								return "<tr><td colspan=\"2\">검색 결과가 없습니다.</td></tr>"
							} else {
								return str;
							}
						}
					} else {
						alert("가격을 다시 입력하세요.");
					}
			    }
			};
			xhttp.open("GET", "../songcon", true);
			xhttp.send();
			
		}
	</script>
</body>
</html>